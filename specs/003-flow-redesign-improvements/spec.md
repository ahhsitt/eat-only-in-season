# Feature Specification: 应用流程重构与功能增强

**Feature Branch**: `003-flow-redesign-improvements`
**Created**: 2026-01-12
**Updated**: 2026-01-13
**Status**: Draft
**Input**: User description: "重新调整流程：输入城市后先展示应季食材列表，用户勾选后获取菜谱；修复任意城市支持、添加PDF导出、应季食材介绍模块、偏好设置与搜索合并、全中文输出"

## Clarifications

### Session 2026-01-12

- Q: 当用户选择多种食材时，系统应如何匹配菜谱？ → A: 部分匹配 - 菜谱包含任意一种选中食材即可，按匹配数量排序
- Q: 系统应如何获取应季食材和菜谱数据？ → A: AI实时生成 - 通过AI服务根据城市和当前季节实时生成食材和菜谱信息
- Q: 系统应提供哪些偏好设置类型？ → A: 自定义文本 - 用户可自由输入偏好描述（如"不吃辣"、"素食"、"对海鲜过敏"等）
- Q: 菜谱列表每次展示多少道菜谱？ → A: 5道 - 适中数量，平衡选择与加载速度
- Q: 食材详细介绍应如何呈现？ → A: 弹窗模态框 - 在当前页面弹出覆盖层展示详情

### Session 2026-01-13 (新增需求)

- 用户要求移除旧流程，不保留 `/old` 路由
- 用户反馈图片与实物不符（如选择"马鲛鱼"但生成的图片是其他鱼类），需要优化图片生成提示词的精准度
- 用户要求AI请求数据使用LRU缓存或SQLite存储，支持配置选项，SQLite方案需支持定时清理
- 用户反馈图片尺寸与前端页面不适配，无法看到���图
- 用户反馈PDF样式不佳，要求去掉圆圈线条装饰，文本可添加小图标（如tips、light等）

### Session 2026-01-13 (澄清)

- Q: 当AI服务不可用时，系统应采取什么降级策略？ → A: 完全阻断 - 显示错误页面，提示用户稍后重试
- Q: AI生成数据的缓存默认过期时间应设为多久？ → A: 双层缓存架构 - 内存LRU缓存默认1小时，SQLite持久化缓存默认7天
- Q: 缓存查询顺序是什么？ → A: 三级查询 - 先查内存LRU缓存 → 未命中则查SQLite → 都未命中则调用AI生成并同时写入两级缓存
- Q: AI生成的图片URL过期后如何处理？ → A: 下载存储 - 获取URL后立即下载图片并以Base64形式存入SQLite，与其他缓存数据使用相同的双层缓存架构和清理策略（内存1小时，SQLite 7天）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查询城市应季食材 (Priority: P1)

用户输入任意城市或地区名称（如"汕尾"、"东京"等），系统返回该地区当季可食用的食材列表。食材按类别（肉类、蔬菜、水果、海鲜等）分组展示在同一页面上，无需通过标签页切换。每个食材都带有简短介绍，说明其应季原因和特点。

**Why this priority**: 这是整个应用的核心入口，用户必须先获取应季食材信息才能进行后续的菜谱推荐。这是最基础且必要的功能。

**Independent Test**: 可以通过输入城市名称并验证返回的食材列表是否正确展示来独立测试。用户能够看到分类的食材列表即表示功能可用。

**Acceptance Scenarios**:

1. **Given** 用户在首页，**When** 输入城市名称"汕尾"并提交，**Then** 系统展示汕尾地区当季的应季食材列表，按肉类、蔬菜、海鲜、水果等分类展示
2. **Given** 用户在首页，**When** 输入国际城市名称"东京"，**Then** 系统以中文展示东京地区当季食材列表，所有文本均为中文
3. **Given** 用户在首页，**When** 输入一个偏远或小众城市，**Then** 系统返回最接近该地区的应季食材信息，而非报错
4. **Given** 食材列表已展示，**When** 用户查看某个食材，**Then** 能看到该食材的简短应季介绍说明

---

### User Story 2 - 基于食材获取菜谱推荐 (Priority: P1)

用户在应季食材列表中勾选想要使用的食材，然后点击获取菜谱。系统根据选中的食材推荐相关菜谱。如果用户没有选择任何食材，系统直接随机推荐当季菜谱。

**Why this priority**: 菜谱推荐是应用的核心价值，与食材查询同等重要，构成完整的用户旅程。

**Independent Test**: 可以通过选择食材并查看返回的菜谱列表来独立测试。即使食材查询功能简化，菜谱推荐功能也能独立运作。

**Acceptance Scenarios**:

1. **Given** 用户已查看应季食材列表，**When** 勾选"番茄"和"牛肉"后点击获取菜谱，**Then** 系统展示包含番茄和牛肉的菜谱列表
2. **Given** 用户已查看应季食材列表，**When** 不选择任何食材直接点击获取菜谱，**Then** 系统随机推荐当季菜谱
3. **Given** 菜谱列表已展示，**When** 用户点击某个菜谱，**Then** 系统自动开始加载菜谱详情和图片，显示加载动画

---

### User Story 3 - 查看菜谱详情与精准图片 (Priority: P2)

用户点击菜谱进入详情页面，系统自动请求并展示菜谱图片。图片生成时使用精准的提示词，确保生成的图片与菜品名称高度匹配（如"马鲛鱼"必须生成马鲛鱼的图片，而非其他鱼类）。图片在页面中完整展示，用户可以看到全图而非被裁剪。

**Why this priority**: 详情页是用户获取完整菜谱信息的关键页面，图片的准确性直接影响用户体验和信任度。

**Independent Test**: 可以通过直接访问菜谱详情页，验证图片与菜品名称的一致性，以及图片是否完整显示来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户点击菜谱列表中的"清蒸马鲛鱼"，**When** 进入详情页，**Then** 系统生成的图片必须是马鲛鱼（体型修长、侧扁、银灰色）而非其他鱼类
2. **Given** 用户查看菜谱"红烧狮子头"，**When** 图片加载完成，**Then** 图片展示的是大肉丸子形态的狮子头，而非其他形态的肉类菜品
3. **Given** 图片加载完成，**When** 用户查看详情页，**Then** 图片完整显示在页面中，无裁剪，可以看到菜品全貌
4. **Given** 图片加载失败，**When** 请求超时或出错，**Then** 显示默认占位图并提供重试选项

---

### User Story 4 - 导出精美PDF菜谱 (Priority: P2)

用户在菜谱详情页可以将当前菜谱导出为PDF文件，包含完整的食材清单、烹饪步骤和图片。PDF采用简洁美观的设计，使用小图标点缀内容（如💡表示小贴士、📝表示步骤等），不使用圆圈线条等过度装饰。

**Why this priority**: 导出功能提供了重要的用户价值，PDF的美观程度影响用户分享和打印体验。

**Independent Test**: 可以通过在详情页点击导出按钮，验证PDF生成效果和下载功能来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在菜谱详情页，**When** 点击"导出PDF"按钮，**Then** 系统生成包含菜谱内容的PDF文件并自动下载
2. **Given** PDF生成完成，**When** 用户打开PDF，**Then** PDF使用简洁设计，步骤编号使用纯数字或小图标，不使用圆圈包裹的样式
3. **Given** PDF包含小贴士内容，**When** 用户查看，**Then** 小贴士前有💡图标，烹饪步骤标题有👨‍🍳图标，食材清单标题有🥬图标
4. **Given** PDF包含中文内容，**When** 用户打开PDF，**Then** 中文正确显示无乱码

---

### User Story 5 - 偏好设置与搜索合并 (Priority: P2)

用户的偏好设置（如饮食禁忌、口味偏好等）与搜索模块整合在同一页面，用户可以在输入城市的同时设置个人偏好。偏好设置支持浏览器缓存，用户下次访问时自动恢复之前的设置。

**Why this priority**: 偏好设置合并提升了用户体验，但可以在核心功能稳定后再整合。

**Independent Test**: 可以通过设置偏好、刷新页面验证缓存是否保留来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在首页，**When** 查看页面，**Then** 偏好设置选项与城市搜索框在同一页面展示
2. **Given** 用户设置了偏好（如"不吃辣"），**When** 获取菜谱，**Then** 推荐结果排除辣味菜品
3. **Given** 用户设置了偏好，**When** 关闭浏览器后重新访问，**Then** 之前的偏好设置自动恢复
4. **Given** 用户清除浏览器缓存，**When** 重新访问应用，**Then** 偏好设置恢复为默认值

---

### User Story 6 - 应季食材介绍模块 (Priority: P3)

系统提供一个专门的应季食材介绍模块，展示每种食材为何当季、其营养价值、挑选技巧等信息。用户可以通过点击食材名称或专门的"了解更多"按钮查看详细介绍。

**Why this priority**: 介绍模块是锦上添花的功能，提供教育价值但不影响核心使用流程。

**Independent Test**: 可以通过点击食材查看详细介绍来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在食材列表页面，**When** 点击某食材的"了解更多"，**Then** 弹出模态框展示该食材的详细介绍信息
2. **Given** 食材介绍弹窗已展示，**When** 用户阅读，**Then** 内容包含应季原因、营养价值、挑选建议等
3. **Given** 用户查看介绍弹窗，**When** 点击关闭或点击遮罩层，**Then** 弹窗关闭，返回食材列表原位置

---

### User Story 7 - AI数据双层缓存管理 (Priority: P2)

系统对AI请求的数据采用双层缓存架构：第一层为内存LRU缓存（默认1小时过期，适合热点数据快速访问），第二层为SQLite持久化缓存（默认7天过期，适合数据持久保存）。数据查询遵循三级顺序：先查内存缓存 → 未命中则查SQLite → 都未命中则调用AI生成，生成后同时写入两级缓存。SQLite支持定时清理过期数据。

**Why this priority**: 双层缓存架构既能保证热点数据的快速响应，又能在服务重启后快速恢复，对用户体验和成本控制都很重要。

**Independent Test**: 可以通过重复请求相同数据，验证响应时间是否显著缩短；重启服务后验证数据是否从SQLite恢复到内存缓存。

**Acceptance Scenarios**:

1. **Given** 用户首次查询某城市食材，**When** 数据从AI生成返回，**Then** 数据同时写入内存LRU缓存和SQLite缓存
2. **Given** 用户在1小时内重复查询同一城市，**When** 发起请求，**Then** 直接从内存LRU缓存返回，响应时间极短
3. **Given** 内存缓存已过期（超过1小时）但SQLite缓存未过期，**When** 用户查询，**Then** 从SQLite读取并重新加载到内存缓存
4. **Given** 服务重启后，**When** 用户查询之前查过的数据，**Then** 从SQLite恢复数据并加载到内存缓存
5. **Given** SQLite缓存运行中，**When** 数据超过7天过期时间，**Then** 定时任务自动清理过期数据

---

### User Story 8 - 移除旧版流程 (Priority: P1)

系统移除旧版流程入口（`/old`路由），仅保留新版流程作为唯一的用户交互方式，简化代码维护并统一用户体验。

**Why this priority**: 清理旧代码是保持代码库整洁的必要步骤，避免维护两套流程带来的混乱。

**Independent Test**: 可以通过访问旧路由验证是否正确重定向或返回404来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户访问应用根路径`/`，**When** 页面加载，**Then** 直接进入新版流程首页
2. **Given** 用户尝试访问`/old`路径，**When** 请求发送，**Then** 返回404或重定向到新版首页
3. **Given** 开发者查看代码库，**When** 检查路由配置，**Then** 不存在旧版流程相关的组件和路由

---

### Edge Cases

- 用户输入不存在的地名时怎么处理？（系统应尝试模糊匹配或提供最接近的地区）
- 用户输入的城市在数据库中没有应季信息怎么办？（系统应提供通用的季节性建议或邻近地区的数据）
- 用户选择的食材组合没有匹配的菜谱怎么办？（系统应提示并建议减少食材或展示部分匹配的菜谱）
- PDF导出时图片尚未加载完成怎么办？（系统应等待图片加载或使用占位提示）
- 浏览器不支持本地存储怎么办？（系统应正常运行但不保存偏好，可提示用户）
- 网络断开时用户操作如何处理？（显示友好的离线提示，已缓存的数据仍可查看）
- 图片生成提示词中包含特殊字符或非常规食材名称时如何处理？（系统应进行适当转义和翻译处理）
- SQLite缓存文件损坏时如何处理？（系统应能自动重建缓存，不影响正常服务）
- 缓存清理任务执行时有大量并发请求如何处理？（清理任务应不阻塞正常请求）
- AI服务不可用（超时、配额耗尽、服务宕机）时如何处理？（采用完全阻断策略，显示错误页面提示用户稍后重试，不使用缓存降级或静态兜底）
- AI生成的图片URL过期时如何处理？（系统在获取URL后立即下载图片并存储Base64，不依赖外部URL有效期；若下载失败则重新生成）

## Requirements *(mandatory)*

### Functional Requirements

#### 核心流程

- **FR-001**: 系统必须支持用户输入任意城市或地区名称进行查询，包括国内城市（如"汕尾"）和国际城市（如"东京"）
- **FR-002**: 系统必须以分类形式展示应季食材列表，分类包括但不限于：肉类、蔬菜、水果、海鲜、蛋奶，所有分类在同一页面展示
- **FR-003**: 系统必须为每种应季食材提供简短的介绍说明，包含应季原因和特点
- **FR-004**: 系统必须允许用户通过勾选方式选择多种食材
- **FR-005**: 系统必须根据用户选择的食材推荐相关菜谱，采用部分匹配策略（菜谱包含任意一种选中食材即可），结果按匹配食材数量降序排列，每次展示5道菜谱
- **FR-006**: 系统必须在用户未选择食材时提供随机的当季菜谱推荐
- **FR-007**: 系统必须确保所有输出文本为中文，无论输入的城市是国内还是国际城市

#### 图片生成

- **FR-008**: 系统必须在菜谱详情页自动加载菜谱图片，无需用户手动触发
- **FR-009**: 系统必须在图片加载过程中显示加载动画
- **FR-010**: 系统必须使用精准的图片生成提示词，包含菜品的具体特征描述（如鱼类需包含外观、颜色、体型等特征），确保生成图片与菜品名称高度匹配
- **FR-011**: 图片生成提示词必须包含菜品中文名称的英文翻译或拼音，以及该食材的视觉特征关键词，避免生成错误的食材图片
- **FR-012**: 前端页面必须完整显示菜品图片，使用适当的CSS样式（如object-fit: contain或自适应容器）确保图片不被裁剪

#### PDF导出

- **FR-013**: 系统必须支持将菜谱详情导出为PDF格式
- **FR-014**: PDF样式必须简洁美观，步骤编号使用纯数字或序号样式，不使用圆圈包裹的装饰样式
- **FR-015**: PDF中必须使用小图标点缀不同内容区块：💡用于小贴士、👨‍🍳用于烹饪步骤标题、🥬用于食材清单标题
- **FR-016**: PDF布局必须清晰，使用合理的间距和字体大小，提升可读性

#### 偏好与缓存

- **FR-017**: 系统必须将偏好设置模块与搜索模块整合在同一页面
- **FR-018**: 系统必须支持偏好设置的浏览器本地缓存
- **FR-019**: 系统必须提供应季食材的详细介绍模块，以弹窗模态框形式展示，内容包含营养价值、挑选建议等信息
- **FR-020**: 系统必须对用户输入的模糊或错误城市名进行智能匹配或提供建议

#### AI数据缓存

- **FR-021**: 系统必须采用双层缓存架构：第一层为内存LRU缓存，第二层为SQLite持久化缓存，两层同时启用
- **FR-022**: 内存LRU缓存默认过期时间为1小时，SQLite缓存默认过期时间为7天，均支持配置调整
- **FR-023**: 数据查询必须遵循三级顺序：先查内存LRU缓存 → 未命中则查SQLite → 都未命中则调用AI生成
- **FR-024**: AI生成的数据必须同时写入内存LRU缓存和SQLite缓存
- **FR-025**: 从SQLite读取的数据必须同时加载到内存LRU缓存，以加速后续访问
- **FR-026**: SQLite缓存必须支持定时清理过期数据，清理间隔可配��
- **FR-027**: 缓存必须支持以下数据类型：城市查询结果、食材列表、菜谱列表、菜谱详情、生成的图片数据（Base64格式）
- **FR-031**: AI生成图片后，系统必须立即下载图片并以Base64格式存储到缓存，不依赖外部URL的有效期

#### 故障处理

- **FR-028**: 当AI服务不可用时，系统必须显示错误页面，明确提示用户服务暂时不可用并建议稍后重试，不采用缓存降级或静态数据兜底

#### 代码清理

- **FR-029**: 系统必须移除旧版流程的所有代码和路由（`/old`路径及相关组件）
- **FR-030**: 访问已移除的旧路径时，系统必须返回404或重定向到新版首页

### Key Entities

- **城市/地区 (Location)**: 用户输入的查询地点，包含地理位置、季节信息、关联的应季食材
- **应季食材 (Seasonal Ingredient)**: 当前季节适合食用的食材，包含名称、分类、应季月份、简介、详细说明、营养信息、视觉特征描述
- **菜谱 (Recipe)**: 可制作的菜品，包含标题、食材清单、烹饪步骤、图片、口味标签、所需时间
- **用户偏好 (User Preference)**: 用户的饮食偏好设置，采用自定义文本输入方式，用户可自由描述饮食禁忌、口味偏好、过敏原等
- **缓存配置 (Cache Configuration)**: 双层缓存架构配置，包含内存LRU缓存过期时间（默认1小时）、SQLite缓存过期时间（默认7天）、LRU缓存大小限制、SQLite清理间隔等参数
- **缓存条目 (Cache Entry)**: 缓存存储的数据条目，包含键、值、创建时间、过期时间、访问次数等元数据，同时存在于内存和SQLite两层；图片数据以Base64格式存储，与其他数据使用相同的过期策略

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户从输入城市到看到应季食材列表的时间不超过3秒
- **SC-002**: 系统能够识别并返回结果的城市/地区覆盖率达到95%以上（包括国内小城市和主要国际城市）
- **SC-003**: 90%的用户能够在首次使用时成功完成"输入城市-选择食材-获取菜谱"的完整流程
- **SC-004**: 图片与菜品名称的匹配准确率达到90%以上（通过人工抽检验证）
- **SC-005**: 菜品图片在详情页完整显示，无裁剪，用户满意度达到85%以上
- **SC-006**: PDF导出功能成功率达到98%，导出文件包含完整信息且中文无乱码
- **SC-007**: PDF样式满意度调查中，用户认为"简洁美观"的比例达到80%以上
- **SC-008**: 偏好设置缓存准确恢复率达到99%
- **SC-009**: 所有界面输出文本100%为中文，无混合语言情况
- **SC-010**: 页面响应流畅，用户交互操作反馈时间不超过100毫秒
- **SC-011**: 内存缓存命中时，重复请求响应时间减少95%以上；SQLite缓存命中时，响应时间减少80%以上
- **SC-012**: 服务重启后，从SQLite恢复缓存数据成功率达到99%
- **SC-013**: 旧版流程代码100%移除，无残留路由或组件

## Assumptions

- 用户使用的是现代浏览器，支持本地存储（localStorage）功能
- 应季食材和菜谱数据通过AI服务实时生成，根据用户输入的城市和当前季节动态返回结果，无需预置数据库
- 用户网络环境良好，能够正常加载图片和PDF生成所需资源
- PDF生成使用服务端方案，前端请求后端API获取生成的PDF
- 图片生成服务支持详细的提示词描述，能够根据食材特征生成准确的图片
- 服务器环境支持SQLite数据库文件存储（如果选择SQLite缓存策略）
- 定时任务可以在服务端可靠执行（用于SQLite缓存清理）
