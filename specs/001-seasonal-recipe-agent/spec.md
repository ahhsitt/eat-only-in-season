# 功能规范：应季食谱推荐 AI Agent

**Feature Branch**: `001-seasonal-recipe-agent`
**Created**: 2026-01-07
**Updated**: 2026-01-08
**Status**: Draft (v3)
**Input**: 用户描述: "完整实现一个AI Agent，包括前后端。该Agent需要能够推荐应季的食谱，根据用户选择的城市、个人喜好，推荐应季的几个菜谱；需要生成菜谱的制作过程，以及生成准确的最终菜色图片。支持PDF导出和多模型切换。"

## 变更记录

### v3 (2026-01-08)
- **提示词优化**: 明确所有 AI 提示词必须使用中文，并提供详尽的上下文描述
- **细化城市支持说明**: 强调全球城市支持，支持中英文等多语言输入
- **完善多模型切换逻辑**: 详细说明环境变量检测和模型选择策略

### v2 (2026-01-08)
- **城市支持**: 从"地区"改为"全球城市"，支持世界主要城市
- **个人偏好**: 从选项式改为自然语言文本输入（限200字）
- **PDF导出**: 新增菜谱导出功能，图片内嵌避免链接失效
- **多模型支持**: 通过环境变量自动检测并选择LLM和图像生成服务
- **提示词优化**: 全部使用中文提示词，更详尽的上下文描述

---

## 用户场景与测试 *(必填)*

### 用户故事 1 - 获取应季食谱推荐 (Priority: P1)

作为一个注重健康饮食的用户，我想要根据我所在的城市和当前季节，获得应季食材的菜谱推荐，以便我能够吃到最新鲜、最健康的食物。

**Why this priority**: 这是产品的核心价值主张。没有应季推荐功能，产品就没有存在意义。

**Independent Test**: 用户输入城市后，系统返回当季可用的菜谱列表，包含菜名和简要描述。

**Acceptance Scenarios**:

1. **Given** 用户首次访问应用, **When** 用户输入城市名称（如"东京"、"Tokyo"、"巴黎"、"Paris"、"成都"、"New York"）, **Then** 系统展示 3-5 个应季菜谱卡片，包含菜名和简介，菜谱风格符合当地饮食文化
2. **Given** 用户输入城市, **When** 当前季节变化（如从冬季进入春季）, **Then** 推荐的菜谱自动更新为新季节的应季食谱
3. **Given** 用户输入一个小众城市, **When** 系统没有该城市的精确数据, **Then** 系统根据该城市的地理位置（纬度、气候带）推断季节和饮食风格
4. **Given** 用户输入非中文城市名, **When** 系统识别城市后, **Then** 推荐内容仍以中文展示，但会标注城市英文名

---

### 用户故事 2 - 查看菜谱详细制作过程 (Priority: P2)

作为一个想要学做菜的用户，当我看到一个感兴趣的菜谱后，我想要查看详细的制作步骤，以便我能够按步骤完成烹饪。

**Why this priority**: 用户获得推荐后，需要知道如何制作。必须先有推荐（P1）才能查看详情。

**Independent Test**: 用户点击任意菜谱卡片后，能看到完整的制作步骤列表。

**Acceptance Scenarios**:

1. **Given** 用户在菜谱列表中看到一个菜谱, **When** 用户点击该菜谱卡片, **Then** 系统展示详细页面，包含：食材清单（含精确用量和单位）、分步骤制作说明（含时间提示）、烹饪小贴士
2. **Given** 用户正在查看菜谱详情, **When** AI 正在生成制作步骤, **Then** 显示骨架屏加载状态，并提示"正在为您生成详细制作步骤..."
3. **Given** 用户查看某个菜谱的制作步骤, **When** 步骤包含专业烹饪技巧, **Then** 系统用通俗易懂的中文语言解释，避免使用晦涩术语

---

### 用户故事 3 - 查看菜品成品图片 (Priority: P3)

作为一个视觉导向的用户，我想要看到菜品的最终成品效果图，以便我能够了解做好后的样子，增加烹饪动力。

**Why this priority**: 图片生成增强用户体验，但不是核心功能。

**Independent Test**: 用户查看菜谱详情时，能看到一张 AI 生成的菜品成品图片。

**Acceptance Scenarios**:

1. **Given** 用户正在查看菜谱详情, **When** 页面加载完成, **Then** 显示 AI 生成的菜品成品图片（高质量、符合菜品特征、色彩诱人）
2. **Given** 图片正在生成中, **When** 用户进入详情页, **Then** 显示加载动画和"正在为您生成菜品图片，请稍候..."提示
3. **Given** 图片生成失败, **When** 用户查看详情, **Then** 显示友好的默认占位图，并提供"重新生成图片"按钮

---

### 用户故事 4 - 设置个人饮食偏好 (Priority: P4)

作为一个有特定饮食习惯的用户，我想要用自然语言描述我的饮食偏好，以便系统能推荐更符合我口味的菜谱。

**Why this priority**: 个性化偏好提升用户体验，但基础推荐功能不依赖于此。

**Independent Test**: 用户输入偏好描述后，返回推荐列表，推荐结果符合描述的偏好条件。

**Acceptance Scenarios**:

1. **Given** 用户进入偏好设置页面, **When** 用户输入"我是素食主义者，不吃任何肉类和海鲜，喜欢清淡口味", **Then** 后续推荐不再包含肉类和海鲜菜谱，优先推荐清淡口味
2. **Given** 用户输入"我对花生和虾过敏，喜欢川菜的麻辣风味", **When** 用户获取推荐, **Then** 推荐结果不包含花生和虾，优先推荐麻辣风味菜品
3. **Given** 用户输入超过200字的偏好文本, **When** 用户尝试提交, **Then** 系统显示剩余字数提示，并在达到上限时阻止继续输入
4. **Given** 用户输入偏好文本, **When** 输入框有内容, **Then** 实时显示"已输入 X/200 字"计数器

---

### 用户故事 5 - 导出菜谱为 PDF (Priority: P5)

作为一个想要保存菜谱的用户，我想要将菜谱导出为 PDF 文件，以便我能够离线查看或打印出来在厨房使用。

**Why this priority**: 导出功能是增值功能，需要在核心功能完成后实现。图片内嵌解决链接时效性问题。

**Independent Test**: 用户点击导出按钮后，下载一个包含完整菜谱信息和图片的 PDF 文件。

**Acceptance Scenarios**:

1. **Given** 用户正在查看菜谱详情, **When** 用户点击"导出PDF"按钮, **Then** 系统生成并下载 PDF 文件，包含：菜品名称、成品图片（内嵌）、食材清单、制作步骤、烹饪小贴士
2. **Given** 菜品图片尚未生成完成, **When** 用户点击导出, **Then** 系统提示"图片正在生成中，您可以选择：1）等待图片完成后导出；2）立即导出无图版本"
3. **Given** 用户导出 PDF, **When** PDF 生成完成, **Then** 图片以 Base64 编码内嵌存储，确保在任何设备上离线可查看
4. **Given** 用户导出 PDF, **When** 导出成功, **Then** PDF 文件名格式为"菜谱名称_导出日期.pdf"

---

### 用户故事 6 - 配置 AI 服务 (Priority: P6)

作为一个技术用户，我想要能够配置使用哪个 AI 服务提供商，以便我能够使用自己拥有 API Key 的服务。

**Why this priority**: 多模型支持是灵活性功能，不影响核心功能使用。

**Independent Test**: 系统启动时自动检测可用的 AI 服务，并在无可用服务时提示用户配置。

**Acceptance Scenarios**:

1. **Given** 用户配置了 OPENAI_API_KEY, **When** 系统启动, **Then** 自动使用 OpenAI 的 GPT 模型和 DALL-E 图像生成
2. **Given** 用户配置了多个 API Key, **When** 系统启动, **Then** 按优先级顺序选择服务（详见多模型支持策略）
3. **Given** 用户未配置任何 API Key, **When** 系统启动, **Then** 显示友好的配置引导页面，说明如何获取和配置各服务商的 API Key
4. **Given** 配置的 API Key 无效或余额不足, **When** 调用 AI 服务失败, **Then** 显示清晰的错误信息，建议检查 API Key 或尝试其他服务商

---

### 边界情况

- 当用户输入的城市无法识别时？→ 提示"未能识别该城市，请尝试输入城市的中文或英文名称"，并提供热门城市列表供选择
- 当 AI 生成内容失败时如何处理？→ 显示友好错误提示"抱歉，生成失败了，请点击重试"，提供重试按钮
- 当用户偏好过于严格导致无结果时？→ 提示"根据您的偏好未找到完全匹配的菜谱，以下是最接近的推荐"，并显示最接近的推荐
- 当图片生成 API 超时时？→ 使用默认占位图，后台异步重试，成功后自动更新页面图片
- 当 PDF 导出失败时？→ 提示"PDF 生成失败，请稍后重试"，并记录错误日志便于排查
- 当用户未配置任何 AI 服务时？→ 启动时检查环境变量，缺失时显示配置引导页面
- 当用户处于南半球城市时？→ 系统根据经纬度正确判断季节（北半球夏季=南半球冬季）

## 需求 *(必填)*

### 功能需求

#### 城市与季节识别
- **FR-001**: 系统必须(MUST)支持用户输入全球任意城市名称，支持中文、英文、拼音等多种输入方式
- **FR-002**: 系统必须(MUST)根据城市地理位置（经纬度）和当前日期自动判断季节，正确处理南北半球季节差异
- **FR-003**: 系统必须(MUST)识别无法匹配的城市输入，并提供友好的错误提示和热门城市建议

#### 菜谱推荐
- **FR-004**: 系统必须(MUST)调用 LLM 生成应季菜谱推荐（3-5 个），根据城市的饮食文化特色推荐当地风味菜品
- **FR-005**: 系统必须(MUST)为每个推荐的菜谱提供简洁的中文描述（50字以内）
- **FR-006**: 系统必须(MUST)根据用户的个人偏好过滤和调整推荐结果

#### 菜谱详情
- **FR-007**: 系统必须(MUST)为每个菜谱生成详细的中文制作步骤，语言通俗易懂
- **FR-008**: 系统必须(MUST)为每个菜谱生成食材清单，包含精确的用量和单位（如"鸡蛋 2个"、"盐 5克"）
- **FR-009**: 系统必须(MUST)为制作步骤提供时间提示（如"翻炒约3分钟"）

#### 图片生成
- **FR-010**: 系统必须(MUST)调用图像生成 AI 创建菜品成品图片，图片应真实诱人
- **FR-011**: 系统必须(MUST)将生成的图片转换为 Base64 格式存储，解决第三方图片链接时效性问题
- **FR-012**: 系统应当(SHOULD)缓存已生成的图片，缓存有效期为24小时，过期后自动失效

#### 个人偏好
- **FR-013**: 系统必须(MUST)支持用户通过自然语言文本描述个人饮食偏好，文本长度限制为200个字符
- **FR-014**: 系统必须(MUST)提供实时字数统计显示（X/200）
- **FR-015**: 系统必须(MUST)使用浏览器本地存储（localStorage）持久化用户的城市选择和偏好设置

#### PDF 导出
- **FR-016**: 系统必须(MUST)支持将菜谱导出为 PDF 格式
- **FR-017**: 系统必须(MUST)在 PDF 中以 Base64 内嵌方式存储图片，确保离线可查看
- **FR-018**: 系统必须(MUST)在 PDF 中包含：菜品名称、成品图片、食材清单、制作步骤、烹饪小贴士
- **FR-019**: 系统应当(SHOULD)提供"导出无图版本"选项，供图片未生成时使用

#### 多模型支持
- **FR-020**: 系统必须(MUST)支持多个 LLM 提供商：OpenAI、DeepSeek、通义千问(Qwen)、Ollama
- **FR-021**: 系统必须(MUST)支持多个图像生成提供商：OpenAI DALL-E、通义万象、Stability AI
- **FR-022**: 系统必须(MUST)通过环境变量中的 API Key 自动检测并选择可用的服务
- **FR-023**: 系统必须(MUST)在无可用 AI 服务时显示配置引导

#### 提示词要求
- **FR-024**: 所有发送给 LLM 的提示词必须(MUST)使用中文编写
- **FR-025**: 提示词必须(MUST)包含详尽的上下文信息，包括：城市信息、当前季节、用户偏好、期望输出格式
- **FR-026**: 提示词应当(SHOULD)指导 AI 输出结构化的 JSON 格式数据，便于前端解析

### 关键实体

- **City（城市）**: 用户输入的城市，包含名称（支持多语言）、经纬度、所属气候带、当前季节
- **Season（季节）**: 春/夏/秋/冬，根据城市位置和当前日期自动计算
- **Recipe（菜谱）**: 包含菜名、简介、食材清单、制作步骤、成品图片（Base64）、适合季节、烹饪时长
- **Ingredient（食材）**: 食材名称、用量数值、单位、是否为当季食材
- **UserPreference（用户偏好）**: 自然语言文本描述，限200字，存储于 localStorage
- **PDFExport（PDF导出）**: 包含完整菜谱信息和内嵌图片的 PDF 文档

### 多模型支持策略

系统通过检测环境变量自动选择可用的 AI 服务：

**LLM 提供商检测优先级**:
| 优先级 | 环境变量 | 服务商 | 默认模型 |
|--------|----------|--------|----------|
| 1      | `OPENAI_API_KEY` | OpenAI | gpt-4o-mini |
| 2      | `DEEPSEEK_API_KEY` | DeepSeek | deepseek-chat |
| 3      | `DASHSCOPE_API_KEY` | 通义千问 | qwen-plus |
| 4      | `OLLAMA_HOST` | Ollama 本地 | llama3 |

**图像生成提供商检测优先级**:
| 优先级 | 环境变量 | 服务商 | 默认模型 |
|--------|----------|--------|----------|
| 1      | `OPENAI_API_KEY` | DALL-E | dall-e-3 |
| 2      | `DASHSCOPE_API_KEY` | 通义万象 | wanx-v1 |
| 3      | `STABILITY_API_KEY` | Stability AI | stable-diffusion-xl |

**检测逻辑**:
- 系统启动时按优先级顺序检查环境变量
- 使用第一个检测到的有效 API Key 对应的服务
- LLM 和图像生成可以使用不同的服务商（如 LLM 用 DeepSeek，图像用 DALL-E）
- 若所有服务都不可用，显示配置引导页面
- 当前服务调用失败时，自动降级到下一优先级服务商，直到所有可用服务都尝试过

## 已澄清问题

### Session 2026-01-07
- Q: 用户身份与持久化方式？ → A: 浏览器本地存储（localStorage），无需登录
- Q: LLM 服务选择？ → A: 支持多模型切换，通过配置选择
- Q: 图像生成 AI 服务？ → A: 支持多服务切换，通过配置选择
- Q: 前端技术栈？ → A: React（Vite）
- Q: 后端技术栈？ → A: Go + Gin

### Session 2026-01-08
- Q: 地区范围？ → A: 全球城市，不限于中国，根据城市文化推荐当地风味
- Q: 个人偏好方式？ → A: 自然语言文本输入，限200字，支持任意描述
- Q: 图片链接时效性？ → A: 导出时将图片转为 Base64 内嵌 PDF，缓存时也存储 Base64
- Q: 多模型切换方式？ → A: 通过环境变量自动检测，按优先级选择可用服务
- Q: 提示词语言？ → A: 全部使用中文提示词，提供详尽上下文描述
- Q: 缓存策略？ → A: 24小时自动过期
- Q: AI服务降级策略？ → A: 自动降级到下一优先级服务商

## 成功标准 *(必填)*

### 可衡量的成果

- **SC-001**: 用户从打开应用到看到第一个菜谱推荐的时间 < 8 秒
- **SC-002**: 菜谱详情页（含制作步骤）完全加载时间 < 15 秒
- **SC-003**: 菜品图片生成时间 < 60 秒（支持异步加载，不阻塞页面展示）
- **SC-004**: PDF 导出完成时间 < 10 秒（含图片内嵌处理）
- **SC-005**: 推荐的菜谱至少 80% 使用当季食材，符合用户所在城市的饮食文化
- **SC-006**: 系统在正常网络条件下可用性 > 99%
- **SC-007**: 用户能够在 3 次点击内完成"进入应用 → 输入城市 → 查看菜谱详情"的完整流程
- **SC-008**: 导出的 PDF 文件在完全离线状态下图片可正常显示
- **SC-009**: 系统正确识别全球主要城市（至少覆盖 100 个常见城市）
- **SC-010**: 用户个人偏好设置在浏览器关闭后重新打开仍然保留
